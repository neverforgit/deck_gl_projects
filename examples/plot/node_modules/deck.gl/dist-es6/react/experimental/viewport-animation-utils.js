/* eslint max-statements: ["error", 50] */

import { projectFlat, unprojectFlat } from 'viewport-mercator-project';
import { Vector2 } from 'math.gl';

var EPSILON = 0.01;

/**
 * Performs linear interpolation of two viewports.
 * @param {Object} startViewport - object containing starting viewport parameters.
 * @param {Object} endViewport - object containing ending viewport parameters.
 * @param {Number} t - animation step.
 * @return {Object} - animated viewport for given step.
*/
export function viewportLinearInterpolator(startViewport, endViewport, t) {
  // here t is easing, check against actual t
  if (t >= 1.0) {
    return endViewport;
  }
  var animatedViewport = Object.assign({}, endViewport);
  function lerp(start, end, step) {
    return step * end + (1 - step) * start;
  }

  var _arr = ['longitude', 'latitude', 'zoom', 'bearing', 'pitch'];
  for (var _i = 0; _i < _arr.length; _i++) {
    var p = _arr[_i];
    var startValue = startViewport[p];
    var endValue = endViewport[p];
    animatedViewport[p] = lerp(startValue, endValue, t);
  }
  return animatedViewport;
}

/**
 * This method adapts mapbox-gl-js Map#flyTo animation so it can be used in
 * react/redux architecture.
 * mapbox-gl-js flyTo : https://www.mapbox.com/mapbox-gl-js/api/#map#flyto.
 * It implements “Smooth and efficient zooming and panning.” algorithm by
 * "Jarke J. van Wijk and Wim A.A. Nuij"
 *
 * @param {Object} startViewport - object containing starting viewport parameters.
 * @param {Object} endViewport - object containing ending viewport parameters.
 * @param {Number} t - animation step.
 * @return {Object} - animated viewport for given step.
*/
export function viewportFlyToInterpolator(startViewport, endViewport, t) {
  // Equations from above paper are referred where needed.

  // here t is easing, check against actual t
  if (t >= 1.0) {
    return endViewport;
  }

  var animatedViewport = Object.assign({}, endViewport);

  function lerp(start, end, step) {
    return step * end + (1 - step) * start;
  }
  function zoomToScale(zoom) {
    return Math.pow(2, zoom);
  }
  function scaleToZoom(scale) {
    return Math.log(scale) / Math.LN2;
  }

  // TODO: add this as an option for applications.
  var rho = 1.414;

  var startZoom = startViewport.zoom;
  var startCenter = [startViewport.longitude, startViewport.latitude];
  var startScale = zoomToScale(startZoom);
  var endZoom = endViewport.zoom;
  var endCenter = [endViewport.longitude, endViewport.latitude];
  var scale = zoomToScale(endZoom - startZoom);

  var startCenterXY = new Vector2(projectFlat(startCenter, startScale));
  var endCenterXY = new Vector2(projectFlat(endCenter, startScale));
  var uDelta = endCenterXY.subtract(startCenterXY);

  var w0 = Math.max(startViewport.width, startViewport.height);
  var w1 = w0 / scale;
  var u1 = Math.sqrt(uDelta.x * uDelta.x + uDelta.y * uDelta.y);
  // u0 is treated as '0' in Eq (9).

  // Linearly interpolate 'bearing' and 'pitch'
  var _arr2 = ['bearing', 'pitch'];
  for (var _i2 = 0; _i2 < _arr2.length; _i2++) {
    var _p = _arr2[_i2];
    var _startValue = startViewport[_p];
    var _endValue = endViewport[_p];
    animatedViewport[_p] = lerp(_startValue, _endValue, t);
  }

  // If change in center is too small, do linear interpolaiton.
  if (Math.abs(u1) < EPSILON) {
    var _arr3 = ['latitude', 'longitude', 'zoom'];

    for (var _i3 = 0; _i3 < _arr3.length; _i3++) {
      var p = _arr3[_i3];
      var startValue = startViewport[p];
      var endValue = endViewport[p];
      animatedViewport[p] = lerp(startValue, endValue, t);
    }
    return animatedViewport;
  }

  // Implement Equation (9) from above algorithm.
  var rho2 = rho * rho;
  var b0 = (w1 * w1 - w0 * w0 + rho2 * rho2 * u1 * u1) / (2 * w0 * rho2 * u1);
  var b1 = (w1 * w1 - w0 * w0 - rho2 * rho2 * u1 * u1) / (2 * w1 * rho2 * u1);
  var r0 = Math.log(Math.sqrt(b0 * b0 + 1) - b0);
  var r1 = Math.log(Math.sqrt(b1 * b1 + 1) - b1);
  function w(s) {
    return Math.cosh(r0) / Math.cosh(r0 + rho * s);
  }
  function u(s) {
    return w0 * ((Math.cosh(r0) * Math.tanh(r0 + rho * s) - Math.sinh(r0)) / rho2) / u1;
  }
  var S = (r1 - r0) / rho;
  var s = t * S;
  var scaleIncrement = 1 / w(s); // Using w method for scaling.
  var newZoom = startZoom + scaleToZoom(scaleIncrement);

  var newCenter = unprojectFlat(startCenterXY.add(uDelta.scale(u(s))).scale(scaleIncrement), zoomToScale(newZoom));
  animatedViewport.longitude = newCenter[0];
  animatedViewport.latitude = newCenter[1];
  animatedViewport.zoom = newZoom;
  return animatedViewport;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9yZWFjdC9leHBlcmltZW50YWwvdmlld3BvcnQtYW5pbWF0aW9uLXV0aWxzLmpzIl0sIm5hbWVzIjpbInByb2plY3RGbGF0IiwidW5wcm9qZWN0RmxhdCIsIlZlY3RvcjIiLCJFUFNJTE9OIiwidmlld3BvcnRMaW5lYXJJbnRlcnBvbGF0b3IiLCJzdGFydFZpZXdwb3J0IiwiZW5kVmlld3BvcnQiLCJ0IiwiYW5pbWF0ZWRWaWV3cG9ydCIsIk9iamVjdCIsImFzc2lnbiIsImxlcnAiLCJzdGFydCIsImVuZCIsInN0ZXAiLCJwIiwic3RhcnRWYWx1ZSIsImVuZFZhbHVlIiwidmlld3BvcnRGbHlUb0ludGVycG9sYXRvciIsInpvb21Ub1NjYWxlIiwiem9vbSIsIk1hdGgiLCJwb3ciLCJzY2FsZVRvWm9vbSIsInNjYWxlIiwibG9nIiwiTE4yIiwicmhvIiwic3RhcnRab29tIiwic3RhcnRDZW50ZXIiLCJsb25naXR1ZGUiLCJsYXRpdHVkZSIsInN0YXJ0U2NhbGUiLCJlbmRab29tIiwiZW5kQ2VudGVyIiwic3RhcnRDZW50ZXJYWSIsImVuZENlbnRlclhZIiwidURlbHRhIiwic3VidHJhY3QiLCJ3MCIsIm1heCIsIndpZHRoIiwiaGVpZ2h0IiwidzEiLCJ1MSIsInNxcnQiLCJ4IiwieSIsImFicyIsInJobzIiLCJiMCIsImIxIiwicjAiLCJyMSIsInciLCJzIiwiY29zaCIsInUiLCJ0YW5oIiwic2luaCIsIlMiLCJzY2FsZUluY3JlbWVudCIsIm5ld1pvb20iLCJuZXdDZW50ZXIiLCJhZGQiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLFNBQVFBLFdBQVIsRUFBcUJDLGFBQXJCLFFBQXlDLDJCQUF6QztBQUNBLFNBQVFDLE9BQVIsUUFBc0IsU0FBdEI7O0FBRUEsSUFBTUMsVUFBVSxJQUFoQjs7QUFFQTs7Ozs7OztBQU9BLE9BQU8sU0FBU0MsMEJBQVQsQ0FBb0NDLGFBQXBDLEVBQW1EQyxXQUFuRCxFQUFnRUMsQ0FBaEUsRUFBbUU7QUFD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QUFwQixJQUF5QkEsRUFBbEMsQ0FBWDtBQUNBLFdBQVNHLENBQVQsQ0FBV0MsQ0FBWCxFQUFjO0FBQ1osV0FBUWxDLEtBQUttQyxJQUFMLENBQVVKLEVBQVYsSUFBZ0IvQixLQUFLbUMsSUFBTCxDQUFVSixLQUFLekIsTUFBTTRCLENBQXJCLENBQXhCO0FBQ0Q7QUFDRCxXQUFTRSxDQUFULENBQVdGLENBQVgsRUFBYztBQUNaLFdBQU9oQixNQUFNLENBQUNsQixLQUFLbUMsSUFBTCxDQUFVSixFQUFWLElBQWdCL0IsS0FBS3FDLElBQUwsQ0FBVU4sS0FBS3pCLE1BQU00QixDQUFyQixDQUFoQixHQUEwQ2xDLEtBQUtzQyxJQUFMLENBQVVQLEVBQVYsQ0FBM0MsSUFBNERILElBQWxFLElBQTBFTCxFQUFqRjtBQUNEO0FBQ0QsTUFBTWdCLElBQUksQ0FBQ1AsS0FBS0QsRUFBTixJQUFZekIsR0FBdEI7QUFDQSxNQUFNNEIsSUFBSWhELElBQUlxRCxDQUFkO0FBQ0EsTUFBTUMsaUJBQWlCLElBQUlQLEVBQUVDLENBQUYsQ0FBM0IsQ0F0RXVFLENBc0V0QztBQUNqQyxNQUFNTyxVQUFVbEMsWUFBWUwsWUFBWXNDLGNBQVosQ0FBNUI7O0FBRUEsTUFBTUUsWUFBWTlELGNBQ2ZrQyxjQUFjNkIsR0FBZCxDQUFrQjNCLE9BQU9iLEtBQVAsQ0FBYWlDLEVBQUVGLENBQUYsQ0FBYixDQUFsQixDQUFELENBQXdDL0IsS0FBeEMsQ0FBOENxQyxjQUE5QyxDQURnQixFQUVoQjFDLFlBQVkyQyxPQUFaLENBRmdCLENBQWxCO0FBR0F0RCxtQkFBaUJzQixTQUFqQixHQUE2QmlDLFVBQVUsQ0FBVixDQUE3QjtBQUNBdkQsbUJBQWlCdUIsUUFBakIsR0FBNEJnQyxVQUFVLENBQVYsQ0FBNUI7QUFDQXZELG1CQUFpQlksSUFBakIsR0FBd0IwQyxPQUF4QjtBQUNBLFNBQU90RCxnQkFBUDtBQUNEIiwiZmlsZSI6InZpZXdwb3J0LWFuaW1hdGlvbi11dGlscy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCBtYXgtc3RhdGVtZW50czogW1wiZXJyb3JcIiwgNTBdICovXG5cbmltcG9ydCB7cHJvamVjdEZsYXQsIHVucHJvamVjdEZsYXR9IGZyb20gJ3ZpZXdwb3J0LW1lcmNhdG9yLXByb2plY3QnO1xuaW1wb3J0IHtWZWN0b3IyfSBmcm9tICdtYXRoLmdsJztcblxuY29uc3QgRVBTSUxPTiA9IDAuMDE7XG5cbi8qKlxuICogUGVyZm9ybXMgbGluZWFyIGludGVycG9sYXRpb24gb2YgdHdvIHZpZXdwb3J0cy5cbiAqIEBwYXJhbSB7T2JqZWN0fSBzdGFydFZpZXdwb3J0IC0gb2JqZWN0IGNvbnRhaW5pbmcgc3RhcnRpbmcgdmlld3BvcnQgcGFyYW1ldGVycy5cbiAqIEBwYXJhbSB7T2JqZWN0fSBlbmRWaWV3cG9ydCAtIG9iamVjdCBjb250YWluaW5nIGVuZGluZyB2aWV3cG9ydCBwYXJhbWV0ZXJzLlxuICogQHBhcmFtIHtOdW1iZXJ9IHQgLSBhbmltYXRpb24gc3RlcC5cbiAqIEByZXR1cm4ge09iamVjdH0gLSBhbmltYXRlZCB2aWV3cG9ydCBmb3IgZ2l2ZW4gc3RlcC5cbiovXG5leHBvcnQgZnVuY3Rpb24gdmlld3BvcnRMaW5lYXJJbnRlcnBvbGF0b3Ioc3RhcnRWaWV3cG9ydCwgZW5kVmlld3BvcnQsIHQpIHtcbiAgLy8gaGVyZSB0IGlzIGVhc2luZywgY2hlY2sgYWdhaW5zdCBhY3R1YWwgdFxuICBpZiAodCA+PSAxLjApIHtcbiAgICByZXR1cm4gZW5kVmlld3BvcnQ7XG4gIH1cbiAgY29uc3QgYW5pbWF0ZWRWaWV3cG9ydCA9IE9iamVjdC5hc3NpZ24oe30sIGVuZFZpZXdwb3J0KTtcbiAgZnVuY3Rpb24gbGVycChzdGFydCwgZW5kLCBzdGVwKSB7XG4gICAgcmV0dXJuIHN0ZXAgKiBlbmQgKyAoMSAtIHN0ZXApICogc3RhcnQ7XG4gIH1cblxuICBmb3IgKGNvbnN0IHAgb2YgWydsb25naXR1ZGUnLCAnbGF0aXR1ZGUnLCAnem9vbScsICdiZWFyaW5nJywgJ3BpdGNoJ10pIHtcbiAgICBjb25zdCBzdGFydFZhbHVlID0gc3RhcnRWaWV3cG9ydFtwXTtcbiAgICBjb25zdCBlbmRWYWx1ZSA9IGVuZFZpZXdwb3J0W3BdO1xuICAgIGFuaW1hdGVkVmlld3BvcnRbcF0gPSBsZXJwKHN0YXJ0VmFsdWUsIGVuZFZhbHVlLCB0KTtcbiAgfVxuICByZXR1cm4gYW5pbWF0ZWRWaWV3cG9ydDtcbn1cblxuLyoqXG4gKiBUaGlzIG1ldGhvZCBhZGFwdHMgbWFwYm94LWdsLWpzIE1hcCNmbHlUbyBhbmltYXRpb24gc28gaXQgY2FuIGJlIHVzZWQgaW5cbiAqIHJlYWN0L3JlZHV4IGFyY2hpdGVjdHVyZS5cbiAqIG1hcGJveC1nbC1qcyBmbHlUbyA6IGh0dHBzOi8vd3d3Lm1hcGJveC5jb20vbWFwYm94LWdsLWpzL2FwaS8jbWFwI2ZseXRvLlxuICogSXQgaW1wbGVtZW50cyDigJxTbW9vdGggYW5kIGVmZmljaWVudCB6b29taW5nIGFuZCBwYW5uaW5nLuKAnSBhbGdvcml0aG0gYnlcbiAqIFwiSmFya2UgSi4gdmFuIFdpamsgYW5kIFdpbSBBLkEuIE51aWpcIlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBzdGFydFZpZXdwb3J0IC0gb2JqZWN0IGNvbnRhaW5pbmcgc3RhcnRpbmcgdmlld3BvcnQgcGFyYW1ldGVycy5cbiAqIEBwYXJhbSB7T2JqZWN0fSBlbmRWaWV3cG9ydCAtIG9iamVjdCBjb250YWluaW5nIGVuZGluZyB2aWV3cG9ydCBwYXJhbWV0ZXJzLlxuICogQHBhcmFtIHtOdW1iZXJ9IHQgLSBhbmltYXRpb24gc3RlcC5cbiAqIEByZXR1cm4ge09iamVjdH0gLSBhbmltYXRlZCB2aWV3cG9ydCBmb3IgZ2l2ZW4gc3RlcC5cbiovXG5leHBvcnQgZnVuY3Rpb24gdmlld3BvcnRGbHlUb0ludGVycG9sYXRvcihzdGFydFZpZXdwb3J0LCBlbmRWaWV3cG9ydCwgdCkge1xuICAvLyBFcXVhdGlvbnMgZnJvbSBhYm92ZSBwYXBlciBhcmUgcmVmZXJyZWQgd2hlcmUgbmVlZGVkLlxuXG4gIC8vIGhlcmUgdCBpcyBlYXNpbmcsIGNoZWNrIGFnYWluc3QgYWN0dWFsIHRcbiAgaWYgKHQgPj0gMS4wKSB7XG4gICAgcmV0dXJuIGVuZFZpZXdwb3J0O1xuICB9XG5cbiAgY29uc3QgYW5pbWF0ZWRWaWV3cG9ydCA9IE9iamVjdC5hc3NpZ24oe30sIGVuZFZpZXdwb3J0KTtcblxuICBmdW5jdGlvbiBsZXJwKHN0YXJ0LCBlbmQsIHN0ZXApIHtcbiAgICByZXR1cm4gc3RlcCAqIGVuZCArICgxIC0gc3RlcCkgKiBzdGFydDtcbiAgfVxuICBmdW5jdGlvbiB6b29tVG9TY2FsZSh6b29tKSB7XG4gICAgcmV0dXJuIE1hdGgucG93KDIsIHpvb20pO1xuICB9XG4gIGZ1bmN0aW9uIHNjYWxlVG9ab29tKHNjYWxlKSB7XG4gICAgcmV0dXJuIE1hdGgubG9nKHNjYWxlKSAvIE1hdGguTE4yO1xuICB9XG5cbiAgLy8gVE9ETzogYWRkIHRoaXMgYXMgYW4gb3B0aW9uIGZvciBhcHBsaWNhdGlvbnMuXG4gIGNvbnN0IHJobyA9IDEuNDE0O1xuXG4gIGNvbnN0IHN0YXJ0Wm9vbSA9IHN0YXJ0Vmlld3BvcnQuem9vbTtcbiAgY29uc3Qgc3RhcnRDZW50ZXIgPSBbc3RhcnRWaWV3cG9ydC5sb25naXR1ZGUsIHN0YXJ0Vmlld3BvcnQubGF0aXR1ZGVdO1xuICBjb25zdCBzdGFydFNjYWxlID0gem9vbVRvU2NhbGUoc3RhcnRab29tKTtcbiAgY29uc3QgZW5kWm9vbSA9IGVuZFZpZXdwb3J0Lnpvb207XG4gIGNvbnN0IGVuZENlbnRlciA9IFtlbmRWaWV3cG9ydC5sb25naXR1ZGUsIGVuZFZpZXdwb3J0LmxhdGl0dWRlXTtcbiAgY29uc3Qgc2NhbGUgPSB6b29tVG9TY2FsZShlbmRab29tIC0gc3RhcnRab29tKTtcblxuICBjb25zdCBzdGFydENlbnRlclhZID0gbmV3IFZlY3RvcjIocHJvamVjdEZsYXQoc3RhcnRDZW50ZXIsIHN0YXJ0U2NhbGUpKTtcbiAgY29uc3QgZW5kQ2VudGVyWFkgPSBuZXcgVmVjdG9yMihwcm9qZWN0RmxhdChlbmRDZW50ZXIsIHN0YXJ0U2NhbGUpKTtcbiAgY29uc3QgdURlbHRhID0gZW5kQ2VudGVyWFkuc3VidHJhY3Qoc3RhcnRDZW50ZXJYWSk7XG5cbiAgY29uc3QgdzAgPSBNYXRoLm1heChzdGFydFZpZXdwb3J0LndpZHRoLCBzdGFydFZpZXdwb3J0LmhlaWdodCk7XG4gIGNvbnN0IHcxID0gdzAgLyBzY2FsZTtcbiAgY29uc3QgdTEgPSBNYXRoLnNxcnQoKHVEZWx0YS54ICogdURlbHRhLngpICsgKHVEZWx0YS55ICogdURlbHRhLnkpKTtcbiAgLy8gdTAgaXMgdHJlYXRlZCBhcyAnMCcgaW4gRXEgKDkpLlxuXG4gIC8vIExpbmVhcmx5IGludGVycG9sYXRlICdiZWFyaW5nJyBhbmQgJ3BpdGNoJ1xuICBmb3IgKGNvbnN0IHAgb2YgWydiZWFyaW5nJywgJ3BpdGNoJ10pIHtcbiAgICBjb25zdCBzdGFydFZhbHVlID0gc3RhcnRWaWV3cG9ydFtwXTtcbiAgICBjb25zdCBlbmRWYWx1ZSA9IGVuZFZpZXdwb3J0W3BdO1xuICAgIGFuaW1hdGVkVmlld3BvcnRbcF0gPSBsZXJwKHN0YXJ0VmFsdWUsIGVuZFZhbHVlLCB0KTtcbiAgfVxuXG4gIC8vIElmIGNoYW5nZSBpbiBjZW50ZXIgaXMgdG9vIHNtYWxsLCBkbyBsaW5lYXIgaW50ZXJwb2xhaXRvbi5cbiAgaWYgKE1hdGguYWJzKHUxKSA8IEVQU0lMT04pIHtcbiAgICBmb3IgKGNvbnN0IHAgb2YgWydsYXRpdHVkZScsICdsb25naXR1ZGUnLCAnem9vbSddKSB7XG4gICAgICBjb25zdCBzdGFydFZhbHVlID0gc3RhcnRWaWV3cG9ydFtwXTtcbiAgICAgIGNvbnN0IGVuZFZhbHVlID0gZW5kVmlld3BvcnRbcF07XG4gICAgICBhbmltYXRlZFZpZXdwb3J0W3BdID0gbGVycChzdGFydFZhbHVlLCBlbmRWYWx1ZSwgdCk7XG4gICAgfVxuICAgIHJldHVybiBhbmltYXRlZFZpZXdwb3J0O1xuICB9XG5cbiAgLy8gSW1wbGVtZW50IEVxdWF0aW9uICg5KSBmcm9tIGFib3ZlIGFsZ29yaXRobS5cbiAgY29uc3QgcmhvMiA9IHJobyAqIHJobztcbiAgY29uc3QgYjAgPSAodzEgKiB3MSAtIHcwICogdzAgKyByaG8yICogcmhvMiAqIHUxICogdTEpIC8gKDIgKiB3MCAqIHJobzIgKiB1MSk7XG4gIGNvbnN0IGIxID0gKHcxICogdzEgLSB3MCAqIHcwIC0gcmhvMiAqIHJobzIgKiB1MSAqIHUxKSAvICgyICogdzEgKiByaG8yICogdTEpO1xuICBjb25zdCByMCA9IE1hdGgubG9nKE1hdGguc3FydChiMCAqIGIwICsgMSkgLSBiMCk7XG4gIGNvbnN0IHIxID0gTWF0aC5sb2coTWF0aC5zcXJ0KGIxICogYjEgKyAxKSAtIGIxKTtcbiAgZnVuY3Rpb24gdyhzKSB7XG4gICAgcmV0dXJuIChNYXRoLmNvc2gocjApIC8gTWF0aC5jb3NoKHIwICsgcmhvICogcykpO1xuICB9XG4gIGZ1bmN0aW9uIHUocykge1xuICAgIHJldHVybiB3MCAqICgoTWF0aC5jb3NoKHIwKSAqIE1hdGgudGFuaChyMCArIHJobyAqIHMpIC0gTWF0aC5zaW5oKHIwKSkgLyByaG8yKSAvIHUxO1xuICB9XG4gIGNvbnN0IFMgPSAocjEgLSByMCkgLyByaG87XG4gIGNvbnN0IHMgPSB0ICogUztcbiAgY29uc3Qgc2NhbGVJbmNyZW1lbnQgPSAxIC8gdyhzKTsgLy8gVXNpbmcgdyBtZXRob2QgZm9yIHNjYWxpbmcuXG4gIGNvbnN0IG5ld1pvb20gPSBzdGFydFpvb20gKyBzY2FsZVRvWm9vbShzY2FsZUluY3JlbWVudCk7XG5cbiAgY29uc3QgbmV3Q2VudGVyID0gdW5wcm9qZWN0RmxhdChcbiAgICAoc3RhcnRDZW50ZXJYWS5hZGQodURlbHRhLnNjYWxlKHUocykpKSkuc2NhbGUoc2NhbGVJbmNyZW1lbnQpLFxuICAgIHpvb21Ub1NjYWxlKG5ld1pvb20pKTtcbiAgYW5pbWF0ZWRWaWV3cG9ydC5sb25naXR1ZGUgPSBuZXdDZW50ZXJbMF07XG4gIGFuaW1hdGVkVmlld3BvcnQubGF0aXR1ZGUgPSBuZXdDZW50ZXJbMV07XG4gIGFuaW1hdGVkVmlld3BvcnQuem9vbSA9IG5ld1pvb207XG4gIHJldHVybiBhbmltYXRlZFZpZXdwb3J0O1xufVxuIl19