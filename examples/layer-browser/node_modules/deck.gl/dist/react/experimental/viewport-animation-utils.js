'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.viewportLinearInterpolator = viewportLinearInterpolator;
exports.viewportFlyToInterpolator = viewportFlyToInterpolator;

var _viewportMercatorProject = require('viewport-mercator-project');

var _math = require('math.gl');

/* eslint max-statements: ["error", 50] */

var EPSILON = 0.01;

/**
 * Performs linear interpolation of two viewports.
 * @param {Object} startViewport - object containing starting viewport parameters.
 * @param {Object} endViewport - object containing ending viewport parameters.
 * @param {Number} t - animation step.
 * @return {Object} - animated viewport for given step.
*/
function viewportLinearInterpolator(startViewport, endViewport, t) {
  // here t is easing, check against actual t
  if (t >= 1.0) {
    return endViewport;
  }
  var animatedViewport = Object.assign({}, endViewport);
  function lerp(start, end, step) {
    return step * end + (1 - step) * start;
  }

  var _arr = ['longitude', 'latitude', 'zoom', 'bearing', 'pitch'];
  for (var _i = 0; _i < _arr.length; _i++) {
    var p = _arr[_i];
    var startValue = startViewport[p];
    var endValue = endViewport[p];
    animatedViewport[p] = lerp(startValue, endValue, t);
  }
  return animatedViewport;
}

/**
 * This method adapts mapbox-gl-js Map#flyTo animation so it can be used in
 * react/redux architecture.
 * mapbox-gl-js flyTo : https://www.mapbox.com/mapbox-gl-js/api/#map#flyto.
 * It implements “Smooth and efficient zooming and panning.” algorithm by
 * "Jarke J. van Wijk and Wim A.A. Nuij"
 *
 * @param {Object} startViewport - object containing starting viewport parameters.
 * @param {Object} endViewport - object containing ending viewport parameters.
 * @param {Number} t - animation step.
 * @return {Object} - animated viewport for given step.
*/
function viewportFlyToInterpolator(startViewport, endViewport, t) {
  // Equations from above paper are referred where needed.

  // here t is easing, check against actual t
  if (t >= 1.0) {
    return endViewport;
  }

  var animatedViewport = Object.assign({}, endViewport);

  function lerp(start, end, step) {
    return step * end + (1 - step) * start;
  }
  function zoomToScale(zoom) {
    return Math.pow(2, zoom);
  }
  function scaleToZoom(scale) {
    return Math.log(scale) / Math.LN2;
  }

  // TODO: add this as an option for applications.
  var rho = 1.414;

  var startZoom = startViewport.zoom;
  var startCenter = [startViewport.longitude, startViewport.latitude];
  var startScale = zoomToScale(startZoom);
  var endZoom = endViewport.zoom;
  var endCenter = [endViewport.longitude, endViewport.latitude];
  var scale = zoomToScale(endZoom - startZoom);

  var startCenterXY = new _math.Vector2((0, _viewportMercatorProject.projectFlat)(startCenter, startScale));
  var endCenterXY = new _math.Vector2((0, _viewportMercatorProject.projectFlat)(endCenter, startScale));
  var uDelta = endCenterXY.subtract(startCenterXY);

  var w0 = Math.max(startViewport.width, startViewport.height);
  var w1 = w0 / scale;
  var u1 = Math.sqrt(uDelta.x * uDelta.x + uDelta.y * uDelta.y);
  // u0 is treated as '0' in Eq (9).

  // Linearly interpolate 'bearing' and 'pitch'
  var _arr2 = ['bearing', 'pitch'];
  for (var _i2 = 0; _i2 < _arr2.length; _i2++) {
    var _p = _arr2[_i2];
    var _startValue = startViewport[_p];
    var _endValue = endViewport[_p];
    animatedViewport[_p] = lerp(_startValue, _endValue, t);
  }

  // If change in center is too small, do linear interpolaiton.
  if (Math.abs(u1) < EPSILON) {
    var _arr3 = ['latitude', 'longitude', 'zoom'];

    for (var _i3 = 0; _i3 < _arr3.length; _i3++) {
      var p = _arr3[_i3];
      var startValue = startViewport[p];
      var endValue = endViewport[p];
      animatedViewport[p] = lerp(startValue, endValue, t);
    }
    return animatedViewport;
  }

  // Implement Equation (9) from above algorithm.
  var rho2 = rho * rho;
  var b0 = (w1 * w1 - w0 * w0 + rho2 * rho2 * u1 * u1) / (2 * w0 * rho2 * u1);
  var b1 = (w1 * w1 - w0 * w0 - rho2 * rho2 * u1 * u1) / (2 * w1 * rho2 * u1);
  var r0 = Math.log(Math.sqrt(b0 * b0 + 1) - b0);
  var r1 = Math.log(Math.sqrt(b1 * b1 + 1) - b1);
  function w(s) {
    return Math.cosh(r0) / Math.cosh(r0 + rho * s);
  }
  function u(s) {
    return w0 * ((Math.cosh(r0) * Math.tanh(r0 + rho * s) - Math.sinh(r0)) / rho2) / u1;
  }
  var S = (r1 - r0) / rho;
  var s = t * S;
  var scaleIncrement = 1 / w(s); // Using w method for scaling.
  var newZoom = startZoom + scaleToZoom(scaleIncrement);

  var newCenter = (0, _viewportMercatorProject.unprojectFlat)(startCenterXY.add(uDelta.scale(u(s))).scale(scaleIncrement), zoomToScale(newZoom));
  animatedViewport.longitude = newCenter[0];
  animatedViewport.latitude = newCenter[1];
  animatedViewport.zoom = newZoom;
  return animatedViewport;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9yZWFjdC9leHBlcmltZW50YWwvdmlld3BvcnQtYW5pbWF0aW9uLXV0aWxzLmpzIl0sIm5hbWVzIjpbInZpZXdwb3J0TGluZWFySW50ZXJwb2xhdG9yIiwidmlld3BvcnRGbHlUb0ludGVycG9sYXRvciIsIkVQU0lMT04iLCJzdGFydFZpZXdwb3J0IiwiZW5kVmlld3BvcnQiLCJ0IiwiYW5pbWF0ZWRWaWV3cG9ydCIsIk9iamVjdCIsImFzc2lnbiIsImxlcnAiLCJzdGFydCIsImVuZCIsInN0ZXAiLCJwIiwic3RhcnRWYWx1ZSIsImVuZFZhbHVlIiwiem9vbVRvU2NhbGUiLCJ6b29tIiwiTWF0aCIsInBvdyIsInNjYWxlVG9ab29tIiwic2NhbGUiLCJsb2ciLCJMTjIiLCJyaG8iLCJzdGFydFpvb20iLCJzdGFydENlbnRlciIsImxvbmdpdHVkZSIsImxhdGl0dWRlIiwic3RhcnRTY2FsZSIsImVuZFpvb20iLCJlbmRDZW50ZXIiLCJzdGFydENlbnRlclhZIiwiZW5kQ2VudGVyWFkiLCJ1RGVsdGEiLCJzdWJ0cmFjdCIsIncwIiwibWF4Iiwid2lkdGgiLCJoZWlnaHQiLCJ3MSIsInUxIiwic3FydCIsIngiLCJ5IiwiYWJzIiwicmhvMiIsImIwIiwiYjEiLCJyMCIsInIxIiwidyIsInMiLCJjb3NoIiwidSIsInRhbmgiLCJzaW5oIiwiUyIsInNjYWxlSW5jcmVtZW50IiwibmV3Wm9vbSIsIm5ld0NlbnRlciIsImFkZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7UUFjZ0JBLDBCLEdBQUFBLDBCO1FBOEJBQyx5QixHQUFBQSx5Qjs7QUExQ2hCOztBQUNBOztBQUhBOztBQUtBLElBQU1DLFVBQVUsSUFBaEI7O0FBRUE7Ozs7Ozs7QUFPTyxTQUFTRiwwQkFBVCxDQUFvQ0csYUFBcEMsRUFBbURDLFdBQW5ELEVBQWdFQyxDQUFoRSxFQUFtRTtBQUN4RTtBQUNBLE1BQUlBLEtBQUssR0FBVCxFQUFjO0FBQ1osV0FBT0QsV0FBUDtBQUNEO0FBQ0QsTUFBTUUsbUJBQW1CQyxPQUFPQyxNQUFQLENBQWMsRUFBZCxFQUFrQkosV0FBbEIsQ0FBekI7QUFDQSxXQUFTSyxJQUFULENBQWNDLEtBQWQsRUFBcUJDLEdBQXJCLEVBQTBCQyxJQUExQixFQUFnQztBQUM5QixXQUFPQSxPQUFPRCxHQUFQLEdBQWEsQ0FBQyxJQUFJQyxJQUFMLElBQWFGLEtBQWpDO0FBQ0Q7O0FBUnVFLGFBVXhELENBQUMsV0FBRCxFQUFjLFVBQWQsRUFBMEIsTUFBMUIsRUFBa0MsU0FBbEMsRUFBNkMsT0FBN0MsQ0FWd0Q7QUFVeEUsMkNBQXVFO0FBQWxFLFFBQU1HLFlBQU47QUFDSCxRQUFNQyxhQUFhWCxjQUFjVSxDQUFkLENBQW5CO0FBQ0EsUUFBTUUsV0FBV1gsWUFBWVMsQ0FBWixDQUFqQjtBQUNBUCxxQkFBaUJPLENBQWpCLElBQXNCSixLQUFLSyxVQUFMLEVBQWlCQyxRQUFqQixFQUEyQlYsQ0FBM0IsQ0FBdEI7QUFDRDtBQUNELFNBQU9DLGdCQUFQO0FBQ0Q7O0FBRUQ7Ozs7Ozs7Ozs7OztBQVlPLFNBQVNMLHlCQUFULENBQW1DRSxhQUFuQyxFQUFrREMsV0FBbEQsRUFBK0RDLENBQS9ELEVBQWtFO0FBQ3ZFOztBQUVBO0FBQ0EsTUFBSUEsS0FBSyxHQUFULEVBQWM7QUFDWixXQUFPRCxXQUFQO0FBQ0Q7O0FBRUQsTUFBTUUsbUJBQW1CQyxPQUFPQyxNQUFQLENBQWMsRUFBZCxFQUFrQkosV0FBbEIsQ0FBekI7O0FBRUEsV0FBU0ssSUFBVCxDQUFjQyxLQUFkLEVBQXFCQyxHQUFyQixFQUEwQkMsSUFBMUIsRUFBZ0M7QUFDOUIsV0FBT0EsT0FBT0QsR0FBUCxHQUFhLENBQUMsSUFBSUMsSUFBTCxJQUFhRixLQUFqQztBQUNEO0FBQ0QsV0FBU00sV0FBVCxDQUFxQkMsSUFBckIsRUFBMkI7QUFDekIsV0FBT0MsS0FBS0MsR0FBTCxDQUFTLENBQVQsRUFBWUYsSUFBWixDQUFQO0FBQ0Q7QUFDRCxXQUFTRyxXQUFULENBQXFCQyxLQUFyQixFQUE0QjtBQUMxQixXQUFPSCxLQUFLSSxHQUFMLENBQVNELEtBQVQsSUFBa0JILEtBQUtLLEdBQTlCO0FBQ0Q7O0FBRUQ7QUFDQSxNQUFNQyxNQUFNLEtBQVo7O0FBRUEsTUFBTUMsWUFBWXRCLGNBQWNjLElBQWhDO0FBQ0EsTUFBTVMsY0FBYyxDQUFDdkIsY0FBY3dCLFNBQWYsRUFBMEJ4QixjQUFjeUIsUUFBeEMsQ0FBcEI7QUFDQSxNQUFNQyxhQUFhYixZQUFZUyxTQUFaLENBQW5CO0FBQ0EsTUFBTUssVUFBVTFCLFlBQVlhLElBQTVCO0FBQ0EsTUFBTWMsWUFBWSxDQUFDM0IsWUFBWXVCLFNBQWIsRUFBd0J2QixZQUFZd0IsUUFBcEMsQ0FBbEI7QUFDQSxNQUFNUCxRQUFRTCxZQUFZYyxVQUFVTCxTQUF0QixDQUFkOztBQUVBLE1BQU1PLGdCQUFnQixrQkFBWSwwQ0FBWU4sV0FBWixFQUF5QkcsVUFBekIsQ0FBWixDQUF0QjtBQUNBLE1BQU1JLGNBQWMsa0JBQVksMENBQVlGLFNBQVosRUFBdUJGLFVBQXZCLENBQVosQ0FBcEI7QUFDQSxNQUFNSyxTQUFTRCxZQUFZRSxRQUFaLENBQXFCSCxhQUFyQixDQUFmOztBQUVBLE1BQU1JLEtBQUtsQixLQUFLbUIsR0FBTCxDQUFTbEMsY0FBY21DLEtBQXZCLEVBQThCbkMsY0FBY29DLE1BQTVDLENBQVg7QUFDQSxNQUFNQyxLQUFLSixLQUFLZixLQUFoQjtBQUNBLE1BQU1vQixLQUFLdkIsS0FBS3dCLElBQUwsQ0FBV1IsT0FBT1MsQ0FBUCxHQUFXVCxPQUFPUyxDQUFuQixHQUF5QlQsT0FBT1UsQ0FBUCxHQUFXVixPQUFPVSxDQUFyRCxDQUFYO0FBQ0E7O0FBRUE7QUF2Q3VFLGNBd0N2RCxDQUFDLFNBQUQsRUFBWSxPQUFaLENBeEN1RDtBQXdDdkUsK0NBQXNDO0FBQWpDLFFBQU0vQixlQUFOO0FBQ0gsUUFBTUMsY0FBYVgsY0FBY1UsRUFBZCxDQUFuQjtBQUNBLFFBQU1FLFlBQVdYLFlBQVlTLEVBQVosQ0FBakI7QUFDQVAscUJBQWlCTyxFQUFqQixJQUFzQkosS0FBS0ssV0FBTCxFQUFpQkMsU0FBakIsRUFBMkJWLENBQTNCLENBQXRCO0FBQ0Q7O0FBRUQ7QUFDQSxNQUFJYSxLQUFLMkIsR0FBTCxDQUFTSixFQUFULElBQWV2QyxPQUFuQixFQUE0QjtBQUFBLGdCQUNWLENBQUMsVUFBRCxFQUFhLFdBQWIsRUFBMEIsTUFBMUIsQ0FEVTs7QUFDMUIsaURBQW1EO0FBQTlDLFVBQU1XLGNBQU47QUFDSCxVQUFNQyxhQUFhWCxjQUFjVSxDQUFkLENBQW5CO0FBQ0EsVUFBTUUsV0FBV1gsWUFBWVMsQ0FBWixDQUFqQjtBQUNBUCx1QkFBaUJPLENBQWpCLElBQXNCSixLQUFLSyxVQUFMLEVBQWlCQyxRQUFqQixFQUEyQlYsQ0FBM0IsQ0FBdEI7QUFDRDtBQUNELFdBQU9DLGdCQUFQO0FBQ0Q7O0FBRUQ7QUFDQSxNQUFNd0MsT0FBT3RCLE1BQU1BLEdBQW5CO0FBQ0EsTUFBTXVCLEtBQUssQ0FBQ1AsS0FBS0EsRUFBTCxHQUFVSixLQUFLQSxFQUFmLEdBQW9CVSxPQUFPQSxJQUFQLEdBQWNMLEVBQWQsR0FBbUJBLEVBQXhDLEtBQStDLElBQUlMLEVBQUosR0FBU1UsSUFBVCxHQUFnQkwsRUFBL0QsQ0FBWDtBQUNBLE1BQU1PLEtBQUssQ0FBQ1IsS0FBS0EsRUFBTCxHQUFVSixLQUFLQSxFQUFmLEdBQW9CVSxPQUFPQSxJQUFQLEdBQWNMLEVBQWQsR0FBbUJBLEVBQXhDLEtBQStDLElBQUlELEVBQUosR0FBU00sSUFBVCxHQUFnQkwsRUFBL0QsQ0FBWDtBQUNBLE1BQU1RLEtBQUsvQixLQUFLSSxHQUFMLENBQVNKLEtBQUt3QixJQUFMLENBQVVLLEtBQUtBLEVBQUwsR0FBVSxDQUFwQixJQUF5QkEsRUFBbEMsQ0FBWDtBQUNBLE1BQU1HLEtBQUtoQyxLQUFLSSxHQUFMLENBQVNKLEtBQUt3QixJQUFMLENBQVVNLEtBQUtBLEVBQUwsR0FBVSxDQUFwQixJQUF5QkEsRUFBbEMsQ0FBWDtBQUNBLFdBQVNHLENBQVQsQ0FBV0MsQ0FBWCxFQUFjO0FBQ1osV0FBUWxDLEtBQUttQyxJQUFMLENBQVVKLEVBQVYsSUFBZ0IvQixLQUFLbUMsSUFBTCxDQUFVSixLQUFLekIsTUFBTTRCLENBQXJCLENBQXhCO0FBQ0Q7QUFDRCxXQUFTRSxDQUFULENBQVdGLENBQVgsRUFBYztBQUNaLFdBQU9oQixNQUFNLENBQUNsQixLQUFLbUMsSUFBTCxDQUFVSixFQUFWLElBQWdCL0IsS0FBS3FDLElBQUwsQ0FBVU4sS0FBS3pCLE1BQU00QixDQUFyQixDQUFoQixHQUEwQ2xDLEtBQUtzQyxJQUFMLENBQVVQLEVBQVYsQ0FBM0MsSUFBNERILElBQWxFLElBQTBFTCxFQUFqRjtBQUNEO0FBQ0QsTUFBTWdCLElBQUksQ0FBQ1AsS0FBS0QsRUFBTixJQUFZekIsR0FBdEI7QUFDQSxNQUFNNEIsSUFBSS9DLElBQUlvRCxDQUFkO0FBQ0EsTUFBTUMsaUJBQWlCLElBQUlQLEVBQUVDLENBQUYsQ0FBM0IsQ0F0RXVFLENBc0V0QztBQUNqQyxNQUFNTyxVQUFVbEMsWUFBWUwsWUFBWXNDLGNBQVosQ0FBNUI7O0FBRUEsTUFBTUUsWUFBWSw0Q0FDZjVCLGNBQWM2QixHQUFkLENBQWtCM0IsT0FBT2IsS0FBUCxDQUFhaUMsRUFBRUYsQ0FBRixDQUFiLENBQWxCLENBQUQsQ0FBd0MvQixLQUF4QyxDQUE4Q3FDLGNBQTlDLENBRGdCLEVBRWhCMUMsWUFBWTJDLE9BQVosQ0FGZ0IsQ0FBbEI7QUFHQXJELG1CQUFpQnFCLFNBQWpCLEdBQTZCaUMsVUFBVSxDQUFWLENBQTdCO0FBQ0F0RCxtQkFBaUJzQixRQUFqQixHQUE0QmdDLFVBQVUsQ0FBVixDQUE1QjtBQUNBdEQsbUJBQWlCVyxJQUFqQixHQUF3QjBDLE9BQXhCO0FBQ0EsU0FBT3JELGdCQUFQO0FBQ0QiLCJmaWxlIjoidmlld3BvcnQtYW5pbWF0aW9uLXV0aWxzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50IG1heC1zdGF0ZW1lbnRzOiBbXCJlcnJvclwiLCA1MF0gKi9cblxuaW1wb3J0IHtwcm9qZWN0RmxhdCwgdW5wcm9qZWN0RmxhdH0gZnJvbSAndmlld3BvcnQtbWVyY2F0b3ItcHJvamVjdCc7XG5pbXBvcnQge1ZlY3RvcjJ9IGZyb20gJ21hdGguZ2wnO1xuXG5jb25zdCBFUFNJTE9OID0gMC4wMTtcblxuLyoqXG4gKiBQZXJmb3JtcyBsaW5lYXIgaW50ZXJwb2xhdGlvbiBvZiB0d28gdmlld3BvcnRzLlxuICogQHBhcmFtIHtPYmplY3R9IHN0YXJ0Vmlld3BvcnQgLSBvYmplY3QgY29udGFpbmluZyBzdGFydGluZyB2aWV3cG9ydCBwYXJhbWV0ZXJzLlxuICogQHBhcmFtIHtPYmplY3R9IGVuZFZpZXdwb3J0IC0gb2JqZWN0IGNvbnRhaW5pbmcgZW5kaW5nIHZpZXdwb3J0IHBhcmFtZXRlcnMuXG4gKiBAcGFyYW0ge051bWJlcn0gdCAtIGFuaW1hdGlvbiBzdGVwLlxuICogQHJldHVybiB7T2JqZWN0fSAtIGFuaW1hdGVkIHZpZXdwb3J0IGZvciBnaXZlbiBzdGVwLlxuKi9cbmV4cG9ydCBmdW5jdGlvbiB2aWV3cG9ydExpbmVhckludGVycG9sYXRvcihzdGFydFZpZXdwb3J0LCBlbmRWaWV3cG9ydCwgdCkge1xuICAvLyBoZXJlIHQgaXMgZWFzaW5nLCBjaGVjayBhZ2FpbnN0IGFjdHVhbCB0XG4gIGlmICh0ID49IDEuMCkge1xuICAgIHJldHVybiBlbmRWaWV3cG9ydDtcbiAgfVxuICBjb25zdCBhbmltYXRlZFZpZXdwb3J0ID0gT2JqZWN0LmFzc2lnbih7fSwgZW5kVmlld3BvcnQpO1xuICBmdW5jdGlvbiBsZXJwKHN0YXJ0LCBlbmQsIHN0ZXApIHtcbiAgICByZXR1cm4gc3RlcCAqIGVuZCArICgxIC0gc3RlcCkgKiBzdGFydDtcbiAgfVxuXG4gIGZvciAoY29uc3QgcCBvZiBbJ2xvbmdpdHVkZScsICdsYXRpdHVkZScsICd6b29tJywgJ2JlYXJpbmcnLCAncGl0Y2gnXSkge1xuICAgIGNvbnN0IHN0YXJ0VmFsdWUgPSBzdGFydFZpZXdwb3J0W3BdO1xuICAgIGNvbnN0IGVuZFZhbHVlID0gZW5kVmlld3BvcnRbcF07XG4gICAgYW5pbWF0ZWRWaWV3cG9ydFtwXSA9IGxlcnAoc3RhcnRWYWx1ZSwgZW5kVmFsdWUsIHQpO1xuICB9XG4gIHJldHVybiBhbmltYXRlZFZpZXdwb3J0O1xufVxuXG4vKipcbiAqIFRoaXMgbWV0aG9kIGFkYXB0cyBtYXBib3gtZ2wtanMgTWFwI2ZseVRvIGFuaW1hdGlvbiBzbyBpdCBjYW4gYmUgdXNlZCBpblxuICogcmVhY3QvcmVkdXggYXJjaGl0ZWN0dXJlLlxuICogbWFwYm94LWdsLWpzIGZseVRvIDogaHR0cHM6Ly93d3cubWFwYm94LmNvbS9tYXBib3gtZ2wtanMvYXBpLyNtYXAjZmx5dG8uXG4gKiBJdCBpbXBsZW1lbnRzIOKAnFNtb290aCBhbmQgZWZmaWNpZW50IHpvb21pbmcgYW5kIHBhbm5pbmcu4oCdIGFsZ29yaXRobSBieVxuICogXCJKYXJrZSBKLiB2YW4gV2lqayBhbmQgV2ltIEEuQS4gTnVpalwiXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IHN0YXJ0Vmlld3BvcnQgLSBvYmplY3QgY29udGFpbmluZyBzdGFydGluZyB2aWV3cG9ydCBwYXJhbWV0ZXJzLlxuICogQHBhcmFtIHtPYmplY3R9IGVuZFZpZXdwb3J0IC0gb2JqZWN0IGNvbnRhaW5pbmcgZW5kaW5nIHZpZXdwb3J0IHBhcmFtZXRlcnMuXG4gKiBAcGFyYW0ge051bWJlcn0gdCAtIGFuaW1hdGlvbiBzdGVwLlxuICogQHJldHVybiB7T2JqZWN0fSAtIGFuaW1hdGVkIHZpZXdwb3J0IGZvciBnaXZlbiBzdGVwLlxuKi9cbmV4cG9ydCBmdW5jdGlvbiB2aWV3cG9ydEZseVRvSW50ZXJwb2xhdG9yKHN0YXJ0Vmlld3BvcnQsIGVuZFZpZXdwb3J0LCB0KSB7XG4gIC8vIEVxdWF0aW9ucyBmcm9tIGFib3ZlIHBhcGVyIGFyZSByZWZlcnJlZCB3aGVyZSBuZWVkZWQuXG5cbiAgLy8gaGVyZSB0IGlzIGVhc2luZywgY2hlY2sgYWdhaW5zdCBhY3R1YWwgdFxuICBpZiAodCA+PSAxLjApIHtcbiAgICByZXR1cm4gZW5kVmlld3BvcnQ7XG4gIH1cblxuICBjb25zdCBhbmltYXRlZFZpZXdwb3J0ID0gT2JqZWN0LmFzc2lnbih7fSwgZW5kVmlld3BvcnQpO1xuXG4gIGZ1bmN0aW9uIGxlcnAoc3RhcnQsIGVuZCwgc3RlcCkge1xuICAgIHJldHVybiBzdGVwICogZW5kICsgKDEgLSBzdGVwKSAqIHN0YXJ0O1xuICB9XG4gIGZ1bmN0aW9uIHpvb21Ub1NjYWxlKHpvb20pIHtcbiAgICByZXR1cm4gTWF0aC5wb3coMiwgem9vbSk7XG4gIH1cbiAgZnVuY3Rpb24gc2NhbGVUb1pvb20oc2NhbGUpIHtcbiAgICByZXR1cm4gTWF0aC5sb2coc2NhbGUpIC8gTWF0aC5MTjI7XG4gIH1cblxuICAvLyBUT0RPOiBhZGQgdGhpcyBhcyBhbiBvcHRpb24gZm9yIGFwcGxpY2F0aW9ucy5cbiAgY29uc3QgcmhvID0gMS40MTQ7XG5cbiAgY29uc3Qgc3RhcnRab29tID0gc3RhcnRWaWV3cG9ydC56b29tO1xuICBjb25zdCBzdGFydENlbnRlciA9IFtzdGFydFZpZXdwb3J0LmxvbmdpdHVkZSwgc3RhcnRWaWV3cG9ydC5sYXRpdHVkZV07XG4gIGNvbnN0IHN0YXJ0U2NhbGUgPSB6b29tVG9TY2FsZShzdGFydFpvb20pO1xuICBjb25zdCBlbmRab29tID0gZW5kVmlld3BvcnQuem9vbTtcbiAgY29uc3QgZW5kQ2VudGVyID0gW2VuZFZpZXdwb3J0LmxvbmdpdHVkZSwgZW5kVmlld3BvcnQubGF0aXR1ZGVdO1xuICBjb25zdCBzY2FsZSA9IHpvb21Ub1NjYWxlKGVuZFpvb20gLSBzdGFydFpvb20pO1xuXG4gIGNvbnN0IHN0YXJ0Q2VudGVyWFkgPSBuZXcgVmVjdG9yMihwcm9qZWN0RmxhdChzdGFydENlbnRlciwgc3RhcnRTY2FsZSkpO1xuICBjb25zdCBlbmRDZW50ZXJYWSA9IG5ldyBWZWN0b3IyKHByb2plY3RGbGF0KGVuZENlbnRlciwgc3RhcnRTY2FsZSkpO1xuICBjb25zdCB1RGVsdGEgPSBlbmRDZW50ZXJYWS5zdWJ0cmFjdChzdGFydENlbnRlclhZKTtcblxuICBjb25zdCB3MCA9IE1hdGgubWF4KHN0YXJ0Vmlld3BvcnQud2lkdGgsIHN0YXJ0Vmlld3BvcnQuaGVpZ2h0KTtcbiAgY29uc3QgdzEgPSB3MCAvIHNjYWxlO1xuICBjb25zdCB1MSA9IE1hdGguc3FydCgodURlbHRhLnggKiB1RGVsdGEueCkgKyAodURlbHRhLnkgKiB1RGVsdGEueSkpO1xuICAvLyB1MCBpcyB0cmVhdGVkIGFzICcwJyBpbiBFcSAoOSkuXG5cbiAgLy8gTGluZWFybHkgaW50ZXJwb2xhdGUgJ2JlYXJpbmcnIGFuZCAncGl0Y2gnXG4gIGZvciAoY29uc3QgcCBvZiBbJ2JlYXJpbmcnLCAncGl0Y2gnXSkge1xuICAgIGNvbnN0IHN0YXJ0VmFsdWUgPSBzdGFydFZpZXdwb3J0W3BdO1xuICAgIGNvbnN0IGVuZFZhbHVlID0gZW5kVmlld3BvcnRbcF07XG4gICAgYW5pbWF0ZWRWaWV3cG9ydFtwXSA9IGxlcnAoc3RhcnRWYWx1ZSwgZW5kVmFsdWUsIHQpO1xuICB9XG5cbiAgLy8gSWYgY2hhbmdlIGluIGNlbnRlciBpcyB0b28gc21hbGwsIGRvIGxpbmVhciBpbnRlcnBvbGFpdG9uLlxuICBpZiAoTWF0aC5hYnModTEpIDwgRVBTSUxPTikge1xuICAgIGZvciAoY29uc3QgcCBvZiBbJ2xhdGl0dWRlJywgJ2xvbmdpdHVkZScsICd6b29tJ10pIHtcbiAgICAgIGNvbnN0IHN0YXJ0VmFsdWUgPSBzdGFydFZpZXdwb3J0W3BdO1xuICAgICAgY29uc3QgZW5kVmFsdWUgPSBlbmRWaWV3cG9ydFtwXTtcbiAgICAgIGFuaW1hdGVkVmlld3BvcnRbcF0gPSBsZXJwKHN0YXJ0VmFsdWUsIGVuZFZhbHVlLCB0KTtcbiAgICB9XG4gICAgcmV0dXJuIGFuaW1hdGVkVmlld3BvcnQ7XG4gIH1cblxuICAvLyBJbXBsZW1lbnQgRXF1YXRpb24gKDkpIGZyb20gYWJvdmUgYWxnb3JpdGhtLlxuICBjb25zdCByaG8yID0gcmhvICogcmhvO1xuICBjb25zdCBiMCA9ICh3MSAqIHcxIC0gdzAgKiB3MCArIHJobzIgKiByaG8yICogdTEgKiB1MSkgLyAoMiAqIHcwICogcmhvMiAqIHUxKTtcbiAgY29uc3QgYjEgPSAodzEgKiB3MSAtIHcwICogdzAgLSByaG8yICogcmhvMiAqIHUxICogdTEpIC8gKDIgKiB3MSAqIHJobzIgKiB1MSk7XG4gIGNvbnN0IHIwID0gTWF0aC5sb2coTWF0aC5zcXJ0KGIwICogYjAgKyAxKSAtIGIwKTtcbiAgY29uc3QgcjEgPSBNYXRoLmxvZyhNYXRoLnNxcnQoYjEgKiBiMSArIDEpIC0gYjEpO1xuICBmdW5jdGlvbiB3KHMpIHtcbiAgICByZXR1cm4gKE1hdGguY29zaChyMCkgLyBNYXRoLmNvc2gocjAgKyByaG8gKiBzKSk7XG4gIH1cbiAgZnVuY3Rpb24gdShzKSB7XG4gICAgcmV0dXJuIHcwICogKChNYXRoLmNvc2gocjApICogTWF0aC50YW5oKHIwICsgcmhvICogcykgLSBNYXRoLnNpbmgocjApKSAvIHJobzIpIC8gdTE7XG4gIH1cbiAgY29uc3QgUyA9IChyMSAtIHIwKSAvIHJobztcbiAgY29uc3QgcyA9IHQgKiBTO1xuICBjb25zdCBzY2FsZUluY3JlbWVudCA9IDEgLyB3KHMpOyAvLyBVc2luZyB3IG1ldGhvZCBmb3Igc2NhbGluZy5cbiAgY29uc3QgbmV3Wm9vbSA9IHN0YXJ0Wm9vbSArIHNjYWxlVG9ab29tKHNjYWxlSW5jcmVtZW50KTtcblxuICBjb25zdCBuZXdDZW50ZXIgPSB1bnByb2plY3RGbGF0KFxuICAgIChzdGFydENlbnRlclhZLmFkZCh1RGVsdGEuc2NhbGUodShzKSkpKS5zY2FsZShzY2FsZUluY3JlbWVudCksXG4gICAgem9vbVRvU2NhbGUobmV3Wm9vbSkpO1xuICBhbmltYXRlZFZpZXdwb3J0LmxvbmdpdHVkZSA9IG5ld0NlbnRlclswXTtcbiAgYW5pbWF0ZWRWaWV3cG9ydC5sYXRpdHVkZSA9IG5ld0NlbnRlclsxXTtcbiAgYW5pbWF0ZWRWaWV3cG9ydC56b29tID0gbmV3Wm9vbTtcbiAgcmV0dXJuIGFuaW1hdGVkVmlld3BvcnQ7XG59XG4iXX0=